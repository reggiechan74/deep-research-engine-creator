# Round 2 Remediation — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix all 14 issues identified in the Claude Opus 4.6 code review of deep-research-engine-creator.

**Architecture:** Sequential, dependency-safe execution across 7 tasks. Templates are fixed first (upstream), then presets, then SKILL.md, then the example is regenerated from the fixed templates, then docs/scripts, then cross-model validation. Each task ends with a verification step and a commit.

**Tech Stack:** Markdown, JSON, Bash (no build system — documentation-only repo)

**Base path:** `/workspaces/reggie-life-plan/deep-research-engine-creator`

---

### Task 1: Fix Template Files (Issues #1, #8, #9, #10)

Fixes 4 issues in 4 template files. These are upstream — all generated output inherits these fixes.

**Files:**
- Modify: `skills/engine-creator/templates/agent-template.md.tmpl:62`
- Modify: `skills/engine-creator/templates/base-research-skill.md.tmpl:35`
- Modify: `skills/engine-creator/templates/extension-skill.md.tmpl` (header area)
- Modify: `skills/engine-creator/templates/sources-command-template.md.tmpl:1-4`
- Modify: `skills/engine-creator/templates/readme-template.md.tmpl:68`

**Step 1: Fix hardcoded iteration limit (Issue #1)**

In `agent-template.md.tmpl`, line 62, change:
```
   - Max 3 iterations per research question
```
to:
```
   - Max {{maxIterations}} iterations per research question
```

**Step 2: Fix phase count (Issue #8)**

In `base-research-skill.md.tmpl`, line 35, change:
```
This engine implements a **four-phase research system** with tier-based depth routing:
```
to:
```
This engine implements a **five-phase research system** with tier-based depth routing:
```

In `extension-skill.md.tmpl`, if any reference to "four-phase" exists, change to "five-phase" similarly.

**Step 3: Add argument-hint to sources template (Issue #9)**

In `sources-command-template.md.tmpl`, change the YAML frontmatter from:
```yaml
---
description: "Display source hierarchy and configuration for {{engineDisplayName}}"
allowed-tools: ["Read"]
---
```
to:
```yaml
---
description: "Display source hierarchy and configuration for {{engineDisplayName}}"
argument-hint: ""
allowed-tools: ["Read"]
---
```

**Step 4: Fix placeholder name in readme template (Issue #10)**

In `readme-template.md.tmpl`, line 68, change:
```
*Generated by [deep-research-engine-creator](https://github.com/reggiechan74/cc-plugins) v{{version}} on {{createdAt}}.*
```
to:
```
*Generated by [deep-research-engine-creator](https://github.com/reggiechan74/cc-plugins) v{{engineVersion}} on {{createdAt}}.*
```

**Step 5: Verify all template fixes**

Run these verification commands:
```bash
# Issue #1: Should find {{maxIterations}}, NOT "Max 3"
grep -n "Max.*iterations" skills/engine-creator/templates/agent-template.md.tmpl

# Issue #8: Should say "five-phase"
grep -n "phase research system" skills/engine-creator/templates/base-research-skill.md.tmpl

# Issue #9: Should have argument-hint
grep -n "argument-hint" skills/engine-creator/templates/sources-command-template.md.tmpl

# Issue #10: Should use {{engineVersion}} not {{version}}
grep -n "version" skills/engine-creator/templates/readme-template.md.tmpl | tail -3
```

**Step 6: Commit**

```bash
git add skills/engine-creator/templates/agent-template.md.tmpl \
      skills/engine-creator/templates/base-research-skill.md.tmpl \
      skills/engine-creator/templates/extension-skill.md.tmpl \
      skills/engine-creator/templates/sources-command-template.md.tmpl \
      skills/engine-creator/templates/readme-template.md.tmpl
git commit -m "fix: correct 4 template issues — iterations, phase count, arg-hint, placeholder name"
```

---

### Task 2: Fix Empty Email in Generation Protocol (Issue #5)

This is a SKILL.md instruction change, not a template change. The template stays as-is; the generation protocol must conditionally remove the email line.

**Files:**
- Modify: `skills/engine-creator/SKILL.md` (Generation Step 3)

**Step 1: Add conditional email instruction**

In `skills/engine-creator/SKILL.md`, find the Generation Step 3 section for plugin.json. After the line about `{{authorEmail}}`, add this instruction:

After the existing text:
```
Replace `{{authorEmail}}` with `engineMeta.author.email` (default: empty string).
```

Change to:
```
Replace `{{authorEmail}}` with `engineMeta.author.email`. **If the email value is empty or `engineMeta.author.email` is absent, remove the entire `"email": "{{authorEmail}}"` line from the generated plugin.json output** (including the trailing comma if it becomes the last property in the author object). Do not emit `"email": ""` — an empty string fails email format validation.
```

**Step 2: Verify**

```bash
grep -A2 "authorEmail" skills/engine-creator/SKILL.md | head -10
```

Should show the conditional removal instruction.

**Step 3: Commit**

```bash
git add skills/engine-creator/SKILL.md
git commit -m "fix: add conditional email omission rule to generation protocol"
```

---

### Task 3: Add Edit Tool to All Preset Agents (Issue #2)

15 identical edits across 5 files. Each agent's tools array gets `"Edit"` added after `"Write"`.

**Files:**
- Modify: `skills/engine-creator/domain-presets/legal-research.json`
- Modify: `skills/engine-creator/domain-presets/market-intelligence.json`
- Modify: `skills/engine-creator/domain-presets/academic-research.json`
- Modify: `skills/engine-creator/domain-presets/osint-investigation.json`
- Modify: `skills/engine-creator/domain-presets/technical-due-diligence.json`

**Step 1: Add Edit tool to all agents**

In each of the 5 preset files, for every agent `"tools"` array, change:
```json
"tools": ["Read", "Write", "Bash", "WebSearch", "WebFetch", "Glob", "Grep"]
```
to:
```json
"tools": ["Read", "Write", "Edit", "Bash", "WebSearch", "WebFetch", "Glob", "Grep"]
```

Each file has 3 agents, so 3 edits per file, 15 total.

**Step 2: Verify**

```bash
# Should return 15 lines, all containing "Edit"
grep '"tools"' skills/engine-creator/domain-presets/*.json

# Should return 0 lines (no tools arrays without Edit)
grep '"tools"' skills/engine-creator/domain-presets/*.json | grep -v '"Edit"'
```

**Step 3: Commit**

```bash
git add skills/engine-creator/domain-presets/*.json
git commit -m "fix: add Edit tool to all 15 preset agents across 5 domain presets"
```

---

### Task 4: Fix SKILL.md — Spot-Check, explorationDepth, Extension Override (Issues #4, #6, #7)

Three fixes in SKILL.md and extension template.

**Files:**
- Modify: `skills/engine-creator/SKILL.md` (derivation rules + Section 8)
- Modify: `skills/engine-creator/templates/extension-skill.md.tmpl`

**Step 1: Standardize spot-check definition (Issue #4)**

In `skills/engine-creator/SKILL.md`, find the Placeholder Derivation Rules table, row for `{{verificationModeInstructions}}`. The `"spot-check"` expansion currently reads:

```
"spot-check" → "Verify a random sample of HIGH-confidence citations (minimum 3 or 20% of HIGH citations, whichever is greater). Record verification results in Methodology_Log.md."
```

Verify this is already present and correct. If the wording differs, update to exactly this canonical version.

**Step 2: Add explorationDepth to wizard Section 8 (Issue #7)**

In `skills/engine-creator/SKILL.md`, find Section 8 (Advanced Configuration). After the line about `max iterations (1-5, default 3)`, add:

```
exploration depth (1-10, default 5) — maximum depth for recursive web exploration from seed URLs (following citation chains and references),
```

So the "If yes" list reads:
```
2. If yes: max iterations (1-5, default 3), exploration depth (1-10, default 5), token budgets (planning: 2000, research: 15000, synthesis: 8000, reporting: 10000), custom hooks, MCP server integrations.
```

**Step 3: Add Advanced Configuration Override to extension template (Issue #6)**

In `skills/engine-creator/templates/extension-skill.md.tmpl`, after the "## Custom Prompts" section (before "## Execution Instructions"), add a new section:

```markdown
---

## Advanced Configuration Override

Override the base skill's advanced settings with engine-specific values. If any of
these values are omitted from the engine configuration, the base skill's defaults
are inherited unchanged.

- **Max iterations per question:** {{maxIterations}}
- **Exploration depth:** {{explorationDepth}}
- **Token budgets:**
  - Planning: {{planningBudget}}
  - Research: {{researchBudget}}
  - Synthesis: {{synthesisBudget}}
  - Reporting: {{reportingBudget}}

When executing the base pipeline, substitute these values wherever the base skill
references iteration limits, exploration depth, or token budgets.
```

Also add to the Placeholder Reference section at the bottom of the extension template:

```markdown
### Advanced Configuration
- `{{maxIterations}}` -- maximum research-refine cycles per question
- `{{explorationDepth}}` -- maximum depth for recursive web exploration from seed URLs
- `{{planningBudget}}` -- token budget for planning phase
- `{{researchBudget}}` -- token budget for research phase (per agent)
- `{{synthesisBudget}}` -- token budget for synthesis phase
- `{{reportingBudget}}` -- token budget for reporting phase
```

**Step 4: Verify**

```bash
# Issue #4: spot-check definition
grep -A2 "spot-check" skills/engine-creator/SKILL.md | grep "minimum 3 or 20%"

# Issue #7: explorationDepth in wizard
grep "exploration depth" skills/engine-creator/SKILL.md

# Issue #6: Advanced override in extension
grep "Advanced Configuration Override" skills/engine-creator/templates/extension-skill.md.tmpl
```

**Step 5: Commit**

```bash
git add skills/engine-creator/SKILL.md \
      skills/engine-creator/templates/extension-skill.md.tmpl
git commit -m "fix: standardize spot-check, add explorationDepth to wizard, add extension advanced override"
```

---

### Task 5: Regenerate Example Engine Files (Issues #3, #12)

This is the most complex task. Delete the hand-written example SKILL.md and regenerate all example files from fixed templates + engine-config.json.

**Files:**
- Modify: `examples/patent-intelligence-engine/engine-config.json` (timestamp fix)
- Regenerate: `examples/patent-intelligence-engine/skills/patent-intelligence-engine/SKILL.md`
- Regenerate: `examples/patent-intelligence-engine/commands/research.md`
- Regenerate: `examples/patent-intelligence-engine/commands/sources.md`
- Regenerate: `examples/patent-intelligence-engine/agents/patent-search-specialist.md`
- Regenerate: `examples/patent-intelligence-engine/agents/prior-art-analyst.md`
- Regenerate: `examples/patent-intelligence-engine/agents/ip-landscape-mapper.md`
- Regenerate: `examples/patent-intelligence-engine/README.md`

**Step 1: Fix example timestamp (Issue #12)**

Get the actual current timestamp:
```bash
TZ='America/New_York' date '+%Y-%m-%dT%H:%M:%S%:z'
```

Update `engine-config.json` field `createdAt` with the result.

**Step 2: Read engine-config.json and all templates**

Read:
- `examples/patent-intelligence-engine/engine-config.json` — source of all config values
- `skills/engine-creator/SKILL.md` — placeholder derivation rules
- All templates from `skills/engine-creator/templates/`

**Step 3: Regenerate SKILL.md**

Apply `base-research-skill.md.tmpl` with values from `engine-config.json`:

1. Compute all derived placeholders using the Placeholder Derivation Rules table in SKILL.md
2. Replace every `{{placeholder}}` with its value
3. Use `●●●, ●●○, ●○○, ○○○` notation for confidence (template standard)
4. Use `[W-01], [E-01], [I-01]` citation prefixes (template standard)
5. Use "five-phase" (from Task 1 fix)
6. Use `Max 4 iterations` (from engine-config `maxIterationsPerQuestion: 4` via Task 1 `{{maxIterations}}` fix)
7. Remove any `<!-- NOTE: manually customized -->` comments
8. Write to `examples/patent-intelligence-engine/skills/patent-intelligence-engine/SKILL.md`

**Step 4: Regenerate commands/research.md**

Apply `command-template.md.tmpl` with engine-config values. Key placeholders:
- `{{engineDisplayName}}` = "Patent Intelligence Engine"
- `{{domain}}` = "Intellectual property and patent landscape analysis"
- `{{audience}}` = "IP attorneys, technology transfer officers, and R&D strategists"
- `{{skillDirName}}` = "patent-intelligence-engine"
- `{{tierSummary}}` = markdown table built from tier config

**Step 5: Regenerate commands/sources.md**

Apply `sources-command-template.md.tmpl` (now with argument-hint from Task 1).

**Step 6: Regenerate all 3 agent files**

Apply `agent-template.md.tmpl` for each agent in `agentPipeline.agents`:
- `patent-search-specialist.md` — color: blue, model: sonnet, type: general-purpose
- `prior-art-analyst.md` — color: magenta, model: sonnet, type: expert-instructor
- `ip-landscape-mapper.md` — color: yellow, model: sonnet, type: intelligence-analyst

Each now correctly says `Max 4 iterations` (via `{{maxIterations}}`).

**Step 7: Regenerate README.md**

Apply `readme-template.md.tmpl`. Footer now correctly uses `{{engineVersion}}` (from Task 1).

**Step 8: Verify no unresolved placeholders**

```bash
# Should return 0 matches (excluding engine-config-schema.json, preset-schema.json)
grep -rn '{{[a-zA-Z0-9_-]*}}' examples/patent-intelligence-engine/ \
  --include='*.md' --include='*.json' \
  | grep -v 'engine-config-schema' | grep -v 'preset-schema'
```

**Step 9: Verify key content changes**

```bash
# Should say "five-phase" not "four-phase"
grep "phase research system" examples/patent-intelligence-engine/skills/patent-intelligence-engine/SKILL.md

# Should say "Max 4 iterations" not "Max 3"
grep "Max.*iterations" examples/patent-intelligence-engine/agents/*.md

# Should NOT contain manual customization note
grep "manually customized" examples/patent-intelligence-engine/skills/patent-intelligence-engine/SKILL.md

# Should use ●●● notation
grep "●●●" examples/patent-intelligence-engine/skills/patent-intelligence-engine/SKILL.md
```

**Step 10: Commit**

```bash
git add examples/patent-intelligence-engine/
git commit -m "fix: regenerate all patent-intelligence-engine files from fixed templates

Resolves Issues #3 (hand-written SKILL.md) and #12 (hardcoded timestamp).
All example files now match template output exactly."
```

---

### Task 6: Fix Docs, Script, and .gitignore (Issues #11, #13, #14)

Three independent fixes for supporting files.

**Files:**
- Modify: `docs/remediation-plan.md`
- Modify: `scripts/publish-engine.sh`
- Create: `.gitignore`

**Step 1: Add status tracking to remediation plan (Issue #11)**

In `docs/remediation-plan.md`, add `**Status: DONE**` line after each finding's heading. For example, change:

```markdown
## Finding 1 [CRITICAL]: plugin-json.tmpl requires fields not in schema/wizard
```
to:
```markdown
## Finding 1 [CRITICAL]: plugin-json.tmpl requires fields not in schema/wizard — DONE
```

Do this for all 13 original findings (all are DONE per commit 568abe4).

Add a new section at the bottom:

```markdown
---

## Round 2 Findings (Claude Opus 4.6 Review)

See `docs/plans/2026-02-21-round2-remediation-design.md` for full design.
See `docs/plans/2026-02-21-round2-remediation-plan.md` for implementation plan.

14 additional issues identified and remediated. Status: DONE.
```

**Step 2: Add warning to publish script (Issue #13)**

In `scripts/publish-engine.sh`, change the branch detection block from:

```bash
DEFAULT_BRANCH=$(git -C "$WORK_DIR/marketplace" symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
```

to:

```bash
DEFAULT_BRANCH=$(git -C "$WORK_DIR/marketplace" symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
if [ -z "$DEFAULT_BRANCH" ]; then
    echo "WARNING: Could not detect default branch, falling back to 'main'" >&2
    DEFAULT_BRANCH="main"
fi
```

**Step 3: Create .gitignore (Issue #14)**

Create `deep-research-engine-creator/.gitignore` with:

```
# Generated engine output — don't commit to plugin repo
generated-engines/
```

**Step 4: Verify**

```bash
# Issue #11: All findings should say DONE
grep "DONE" docs/remediation-plan.md | wc -l

# Issue #13: Should have WARNING message
grep "WARNING" scripts/publish-engine.sh

# Issue #14: .gitignore should exist
cat .gitignore
```

**Step 5: Commit**

```bash
git add docs/remediation-plan.md scripts/publish-engine.sh .gitignore
git commit -m "fix: add remediation status tracking, publish script warning, .gitignore"
```

---

### Task 7: Cross-Model Validation via Codex

Send the full diff to GPT-5.3 (Codex) for cross-model review.

**Step 1: Generate the diff**

```bash
git diff HEAD~6..HEAD -- . ':!docs/plans/'
```

(Adjust `HEAD~N` based on number of commits from Tasks 1-6.)

**Step 2: Run Codex review**

Use `/use-codex` skill to send the diff with this prompt:

> Review this diff against the 14 issues described in docs/plans/2026-02-21-round2-remediation-design.md. For each issue, confirm whether the fix is COMPLETE, PARTIAL, or MISSING. Flag any new issues introduced by the changes. Pay special attention to:
> 1. Template placeholder consistency — do all {{placeholders}} in templates have matching derivation rules?
> 2. Example regeneration — does the patent example SKILL.md look like it was produced by template substitution (not hand-written)?
> 3. Preset completeness — do all 15 agents across 5 presets now include Edit?

**Step 3: Record results**

Add Codex review results to `docs/remediation-plan.md` under the Round 2 section.

**Step 4: Fix any issues Codex identifies**

If Codex finds PARTIAL or MISSING fixes, address them and re-commit.

**Step 5: Final commit (if needed)**

```bash
git add -A
git commit -m "fix: address Codex review feedback on round 2 remediation"
```

---

## Execution Summary

| Task | Issues Fixed | Files | Commit |
|------|-------------|-------|--------|
| 1 | #1, #8, #9, #10 | 5 templates | `fix: correct 4 template issues` |
| 2 | #5 | 1 SKILL.md | `fix: add conditional email omission` |
| 3 | #2 | 5 presets | `fix: add Edit tool to presets` |
| 4 | #4, #6, #7 | 2 files | `fix: spot-check, explorationDepth, extension override` |
| 5 | #3, #12 | 8 example files | `fix: regenerate example from templates` |
| 6 | #11, #13, #14 | 3 files | `fix: docs, script, .gitignore` |
| 7 | — | varies | `fix: address Codex review feedback` |

**Total: 14 issues, ~23 files, 6-7 commits, 1 Codex review cycle.**
